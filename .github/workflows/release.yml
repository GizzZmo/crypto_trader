name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.1.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    name: Build Release Assets
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install build wheel setuptools pyinstaller

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Create setup.py
      run: |
        cat > setup.py << 'EOF'
        from setuptools import setup
        import re
        
        version = "${{ steps.get_version.outputs.VERSION }}"
        # Remove 'v' prefix if present
        version = re.sub(r'^v', '', version)
        
        with open("requirements.txt") as f:
            requirements = [line.strip() for line in f if line.strip() and not line.startswith("#")]
        
        setup(
            name="crypto-trader-bot",
            version=version,
            description="AI-Powered Binance Grid Trading Bot",
            author="GizzZmo",
            py_modules=["bot"],
            install_requires=requirements,
            python_requires=">=3.8",
            classifiers=[
                "Development Status :: 3 - Alpha",
                "Intended Audience :: Developers",
                "Topic :: Office/Business :: Financial :: Investment",
                "License :: OSI Approved :: GNU General Public License v3 (GPLv3)",
                "Programming Language :: Python :: 3.8",
                "Programming Language :: Python :: 3.9",
                "Programming Language :: Python :: 3.10",
                "Programming Language :: Python :: 3.11",
            ],
        )
        EOF

    - name: Build source and wheel distributions
      run: |
        python -m build
        ls -lh dist/

    - name: Create standalone executable (Linux)
      run: |
        pyinstaller --onefile --name crypto-trader-bot-linux --add-data "LICENSE:." bot.py
        ls -lh dist/
      continue-on-error: true

    - name: Create release archive
      run: |
        # Create source archive with all documentation
        mkdir -p release-package
        cp bot.py release-package/
        cp requirements.txt release-package/
        cp README.md release-package/
        cp LICENSE release-package/
        cp CONTRIBUTING.md release-package/
        cp ROADMAP.md release-package/
        cp SECURITY.md release-package/
        cp CHANGELOG.md release-package/
        
        # Create tarball
        tar -czf crypto-trader-bot-${{ steps.get_version.outputs.VERSION }}-source.tar.gz release-package/
        
        # Create zip for Windows users
        zip -r crypto-trader-bot-${{ steps.get_version.outputs.VERSION }}-source.zip release-package/

    - name: Generate checksums
      run: |
        cd dist
        sha256sum * > SHA256SUMS.txt
        cd ..
        sha256sum crypto-trader-bot-*.tar.gz crypto-trader-bot-*.zip >> dist/SHA256SUMS.txt
        cat dist/SHA256SUMS.txt

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-assets-${{ steps.get_version.outputs.VERSION }}
        path: |
          dist/
          crypto-trader-bot-*.tar.gz
          crypto-trader-bot-*.zip
        retention-days: 90

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-assets-${{ steps.get_version.outputs.VERSION }}

    - name: Extract changelog for this version
      id: changelog
      run: |
        # Extract changelog section for this version
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        VERSION_NO_V=$(echo $VERSION | sed 's/^v//')
        
        # Create release notes
        cat > release_notes.md << 'EOF'
        ## What's New
        
        This release includes comprehensive documentation, GitHub workflows, and enhanced project structure.
        
        ### Documentation
        - Complete README with installation and usage guide
        - Contributing guidelines
        - Security policy
        - Development roadmap
        - Changelog
        
        ### GitHub Workflows
        - Code quality checks (linting, formatting)
        - Build and test automation
        - Release automation with artifacts
        
        ### Installation
        
        ```bash
        # From source
        pip install crypto-trader-bot-${VERSION_NO_V}.tar.gz
        
        # Or using wheel
        pip install crypto-trader-bot-${VERSION_NO_V}-py3-none-any.whl
        ```
        
        ### Getting Started
        
        See [README.md](https://github.com/GizzZmo/crypto_trader#readme) for complete documentation.
        
        ### âš ï¸ Important Notes
        
        - Always start with Demo/Testnet mode
        - Never invest more than you can afford to lose
        - Review [SECURITY.md](https://github.com/GizzZmo/crypto_trader/blob/main/SECURITY.md) for best practices
        
        ### Checksums
        
        See SHA256SUMS.txt in the release assets.
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: Release ${{ steps.get_version.outputs.VERSION }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          dist/*
          crypto-trader-bot-*.tar.gz
          crypto-trader-bot-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-summary:
    name: Publish Summary
    runs-on: ubuntu-latest
    needs: [build, create-release]
    if: always()

    steps:
    - name: Create summary
      run: |
        echo "# Release Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Status" >> $GITHUB_STEP_SUMMARY
        echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Release: ${{ needs.create-release.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Source distributions (tar.gz, zip)" >> $GITHUB_STEP_SUMMARY
        echo "- Python wheel package" >> $GITHUB_STEP_SUMMARY
        echo "- Checksum files (SHA256)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Release completed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
